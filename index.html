<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€í•™ ì…ì‹œì˜ ì‹  NEW 2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Jua&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-game { font-family: 'Jua', sans-serif; }
        .font-cute { font-family: 'Gaegu', cursive; }
        
        /* Animations */
        .slide-in { animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bounce-slow { animation: bounce 2s infinite; }
        .pulse-soft { animation: pulse 2s infinite; }
        .shake { animation: shake 0.5s; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .university-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1); }
        .hidden-section { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fff0f5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }

        .bg-cute-pattern {
            background-color: #fff0f3;
            background-image: radial-gradient(#fbcfe8 2px, transparent 2px), radial-gradient(#bfdbfe 2px, transparent 2px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
        }
        /* Army Theme */
        .bg-army {
            background-color: #556b2f;
            background-image: repeating-linear-gradient(45deg, #4b5320 25%, transparent 25%, transparent 75%, #4b5320 75%, #4b5320), repeating-linear-gradient(45deg, #4b5320 25%, #556b2f 25%, #556b2f 75%, #4b5320 75%, #4b5320);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        
        .shadow-cute { box-shadow: 6px 6px 0px 0px rgba(251, 113, 133, 0.4); }
        .btn-push:active { transform: translateY(4px); box-shadow: none !important; }
        
        /* Killer Question Style */
        .killer-mode { border: 4px solid #ef4444 !important; animation: shake 0.5s; background-color: #fef2f2 !important; }
        
        /* Score Change Badge */
        .score-change { display: inline-block; padding: 4px 8px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
        .score-up { background-color: #d1fae5; color: #166534; }
        .score-down { background-color: #fee2e2; color: #991b1b; }
        
        .ai-recommend { animation: pulse 2s infinite; background: linear-gradient(45deg, #ff6b6b, #f06595); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* Letter Style */
        .letter-paper {
            background: #fffdf0;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 2em;
            line-height: 2em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            font-family: 'Gaegu', cursive;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-cute-pattern transition-colors duration-500" id="main-body">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md text-pink-600 p-3 sticky top-0 z-50 border-b-4 border-pink-200 transition-colors duration-500" id="main-header">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
            <h1 class="text-2xl md:text-3xl font-game flex items-center tracking-wider cursor-pointer drop-shadow-sm hover:scale-105 transition" onclick="resetGame('full')">
                <span class="text-3xl mr-2">ğŸ‘‘</span>ëŒ€í•™ ì…ì‹œì˜ ì‹  NEW 2.3
            </h1>
            <div id="status-bar" class="hidden text-xs md:text-sm flex flex-wrap justify-center gap-3 transition-all duration-300 font-bold font-game">
                <span class="bg-yellow-100 px-3 py-1 rounded-full border-2 border-yellow-300 text-yellow-700"><i class="fas fa-user mr-1"></i> <span id="display-name"></span></span>
                <span class="bg-blue-100 px-3 py-1 rounded-full border-2 border-blue-300 text-blue-700"><i class="fas fa-graduation-cap mr-1"></i> <span id="display-major"></span></span>
                <span class="bg-green-100 px-3 py-1 rounded-full border-2 border-green-300 text-green-700"><i class="fas fa-book-open mr-1"></i> ë‚´ì‹ : <span id="display-gpa">0.00</span></span>
                <span class="bg-purple-100 px-3 py-1 rounded-full border-2 border-purple-300 text-purple-700"><i class="fas fa-chart-line mr-1"></i> ìˆ˜ëŠ¥: <span id="display-sat">0</span>%</span>
                <span id="combo-badge" class="hidden bg-red-100 px-3 py-1 rounded-full border-2 border-red-400 text-red-600 animate-pulse"></span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow relative flex flex-col justify-center items-center">
        
        <!-- Scene 1: Intro -->
        <section id="scene-intro" class="max-w-lg w-full relative slide-in z-10 mt-6">
            <div class="absolute -top-16 -left-10 text-7xl float" style="animation-delay: 0s; z-index: -1;">âœ¨</div>
            <div class="absolute top-10 -right-12 text-6xl float" style="animation-delay: 1s; z-index: -1;">ğŸŒˆ</div>

            <div class="bg-white p-8 rounded-[3rem] border-4 border-pink-300 shadow-cute text-center relative overflow-hidden">
                <div class="bg-gradient-to-r from-pink-200 to-purple-200 absolute top-0 left-0 w-full h-8"></div>
                
                <div id="intro-badge" class="mt-6 mb-4 relative inline-block">
                     <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center mx-auto border-4 border-pink-200 shadow-inner">
                        <i class="fas fa-university text-6xl text-pink-500 bounce-slow"></i>
                    </div>
                </div>

                <h1 class="text-4xl font-game text-pink-500 mb-1 tracking-tight drop-shadow-sm" id="game-title">ëŒ€í•™ ì…ì‹œì˜ ì‹ </h1>
                <h2 class="text-2xl font-cute text-slate-500 mb-8" id="game-subtitle">NEW 2.3 : ê³ 3 ì‹¤ì „ ì™„ì„± ğŸ“š</h2>

                <!-- Penalty Alert Box -->
                <div id="penalty-alert" class="hidden mb-6 p-4 rounded-2xl text-sm font-bold border-2 animate-pulse text-left font-game shadow-md bg-red-50 text-red-600 border-red-200"></div>

                <form id="profile-form" class="space-y-4 text-left font-game">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="group">
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ì´ë¦„</label>
                            <input type="text" id="input-name" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm" placeholder="ê¹€ìˆ˜í—˜" required>
                        </div>
                        <div class="group">
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ì¶œì‹  ê³ êµ</label>
                            <input type="text" id="input-school" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm" placeholder="OOê³ " required>
                        </div>
                    </div>
                    
                    <div class="group">
                        <label class="block text-sm text-pink-400 mb-1 ml-2">í¬ë§ í•™ê³¼ (ì „ê³µ ì§ˆë¬¸ ë°˜ì˜)</label>
                        <input type="text" id="input-major" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm" placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™, ê²½ì˜í•™" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ì„±ë³„</label>
                            <select id="input-gender" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm">
                                <option value="M">ë‚¨ì„± ğŸ‘¦</option>
                                <option value="F">ì—¬ì„± ğŸ‘§</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ê³„ì—´</label>
                            <select id="input-track" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm">
                                <option value="ì¸ë¬¸">ì¸ë¬¸ê³„ì—´ ğŸ“š</option>
                                <option value="ìì—°">ìì—°ê³„ì—´ ğŸ”¬</option>
                                <option value="ì˜ˆì²´ëŠ¥">ì˜ˆì²´ëŠ¥ ğŸ¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ë‚´ì‹  (1.0~9.0)</label>
                            <input type="number" id="input-gpa" step="0.1" min="1.0" max="9.0" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm" placeholder="3.5" required>
                        </div>
                        <div>
                            <label class="block text-sm text-pink-400 mb-1 ml-2">ëª¨ì˜ê³ ì‚¬ (%)</label>
                            <input type="number" id="input-sat" min="0" max="100" class="w-full bg-slate-50 border-2 border-pink-200 p-3 rounded-2xl focus:border-pink-400 outline-none text-center text-lg shadow-sm" placeholder="85" required>
                        </div>
                    </div>
                    <button type="submit" id="start-btn" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 hover:from-pink-500 hover:to-rose-500 text-white font-black py-4 rounded-2xl shadow-[0_6px_0_rgb(219,39,119)] active:shadow-none active:translate-y-[6px] transition-all text-xl mt-4 flex justify-center items-center gap-2 btn-push">
                        2027 ëŒ€ì… ì‹œì‘ ğŸš€
                    </button>
                </form>

                <div class="mt-8 pt-4 border-t-2 border-dashed border-pink-100 text-xs text-pink-300 font-bold">
                    Created by Yoo Won Seok
                </div>
            </div>
        </section>

        <!-- Scene 2: Quiz -->
        <section id="scene-quiz" class="hidden-section max-w-2xl w-full mx-auto slide-in">
            <div class="bg-white rounded-[2rem] shadow-cute border-4 border-slate-800 overflow-hidden" id="quiz-container">
                <div class="bg-slate-800 p-6 text-white flex justify-between items-center" id="quiz-header">
                    <div>
                        <h3 class="font-bold text-2xl font-game text-yellow-300" id="quiz-title"><i class="fas fa-brain mr-2"></i>ìˆ˜ëŠ¥ ì‹¤ì „ ë¬¸ì œ!</h3>
                        <p class="text-sm font-cute text-slate-300">ì‹¤ì œ ê¸°ì¶œ ë³€í˜• ë¬¸ì œì…ë‹ˆë‹¤. ì§‘ì¤‘í•˜ì„¸ìš”!</p>
                    </div>
                    <span class="text-lg font-black bg-white/20 px-4 py-2 rounded-xl">Q <span id="current-round">1</span>/<span id="total-rounds">5</span></span>
                </div>
                
                <div class="p-8">
                    <div class="mb-8">
                        <span id="quiz-subject" class="inline-block bg-yellow-100 text-yellow-800 border-2 border-yellow-200 text-sm px-3 py-1 rounded-lg mb-3 font-black font-game">Subject</span>
                        <h2 id="quiz-question" class="text-xl font-bold text-slate-800 leading-relaxed break-keep font-sans">ë¬¸ì œ ë¡œë”©ì¤‘...</h2>
                    </div>
                    <div id="quiz-options" class="grid grid-cols-1 gap-3 font-game text-lg"></div>
                </div>
                
                <div id="quiz-feedback" class="hidden bg-slate-50 p-8 border-t-4 border-slate-100 text-center pop-in">
                    <div id="feedback-icon" class="text-6xl mb-4 inline-block bounce-slow"></div>
                    <p id="feedback-text" class="font-bold text-2xl mb-2 text-slate-700 font-game"></p>
                    <div id="feedback-detail" class="mb-6 h-8"></div>
                    <button id="next-quiz-btn" class="bg-slate-800 text-white px-10 py-3 rounded-2xl hover:bg-black font-bold shadow-lg transition transform hover:scale-105 font-game text-xl">ë‹¤ìŒ ë¬¸ì œ <i class="fas fa-arrow-right ml-1"></i></button>
                </div>
            </div>
        </section>

        <!-- Scene 3: Susi Application -->
        <section id="scene-susi" class="hidden-section slide-in w-full max-w-6xl">
            <div class="text-center mb-8">
                <span class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-sm font-black mb-2 inline-block font-game border-2 border-blue-200">STEP 1</span>
                <h2 class="text-4xl font-black text-slate-800 font-game">ìˆ˜ì‹œ ì›ì„œ ì ‘ìˆ˜</h2>
                <p class="text-sm text-slate-500 mt-2 font-bold font-game">* <span class="text-blue-600 bg-blue-50 px-1 rounded">AI ì¶”ì²œ</span> ë§ˆí¬ë¥¼ í™•ì¸í•˜ì„¸ìš” (ì „í˜• ë‹¤ë¥´ë©´ ì¤‘ë³µ ê°€ëŠ¥)</p>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[600px]">
                <div class="lg:w-2/3 flex flex-col h-[500px] lg:h-full bg-white rounded-[2rem] shadow-lg p-6 border-4 border-slate-100">
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2 flex-shrink-0 scrollbar-hide font-game">
                        <button class="filter-btn active bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap transition shadow-md" data-filter="all">ì „ì²´</button>
                        <button class="filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="sky">SKY</button>
                        <button class="filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="in_seoul_top">ì¸ì„œìš¸ ìƒìœ„</button>
                        <button class="filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="in_seoul_mid">ì¸ì„œìš¸/ìˆ˜ë„ê¶Œ</button>
                        <button class="filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="jigeoguk">ì§€ê±°êµ­</button>
                        <button class="filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="metro_low">ê²½ê¸°/ì¶©ì²­(4~6ë“±ê¸‰)</button>
                    </div>
                    <div id="susi-uni-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto pr-2 pb-2"></div>
                </div>

                <div class="lg:w-1/3 flex flex-col h-auto lg:h-full bg-white rounded-[2rem] shadow-cute p-6 border-4 border-blue-200 relative">
                    <div class="absolute -top-4 -right-4 bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-black text-xl shadow-md z-10 bounce-slow" id="susi-badge">0</div>
                    <h3 class="font-bold text-2xl text-slate-800 font-game mb-4 border-b-2 border-dashed border-blue-100 pb-2">ğŸ“‚ ë‚´ ì›ì„œí•¨</h3>
                    <div class="flex-grow overflow-y-auto bg-blue-50 rounded-xl p-3 mb-4 inner-shadow min-h-[150px] lg:min-h-0">
                        <ul id="susi-cart" class="space-y-2 text-sm font-game"></ul>
                    </div>
                    <button id="btn-susi-submit" class="w-full bg-slate-200 text-slate-400 font-black py-4 rounded-xl transition-all shadow-none cursor-not-allowed text-xl font-game" disabled>ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”</button>
                </div>
            </div>
        </section>

        <!-- Scene 4: Exam Intro -->
        <section id="scene-exam-intro" class="hidden-section max-w-lg mx-auto slide-in mt-10 w-full text-center">
            <div class="bg-white p-10 rounded-[3rem] shadow-cute border-4 border-slate-800 relative overflow-hidden">
                <i class="fas fa-pencil-alt text-7xl text-yellow-400 mb-6 bounce-slow block drop-shadow-md"></i>
                <h2 class="text-4xl font-black text-slate-800 font-game mb-4">ëŒ€í•™ë³„ ê³ ì‚¬</h2>
                <p class="text-slate-500 text-xl mb-8 font-cute">ë§ˆì§€ë§‰ ì—­ì „ì˜ ê¸°íšŒ!<br>ë©´ì ‘ê³¼ ë…¼ìˆ ì—ì„œ ì‹¤ë ¥ì„ ë³´ì—¬ì£¼ì„¸ìš”.</p>
                <button onclick="startActualExams()" class="bg-indigo-600 text-white px-12 py-5 rounded-2xl font-black hover:bg-indigo-700 shadow-[0_6px_0_rgb(55,48,163)] active:shadow-none active:translate-y-[6px] transition text-2xl font-game">ì…ì¥í•˜ê¸° ğŸšª</button>
            </div>
        </section>

        <!-- Scene 4-1: Interview Game -->
        <section id="scene-interview" class="hidden-section max-w-2xl mx-auto slide-in mt-10 w-full">
            <div class="bg-white rounded-[2rem] shadow-xl p-8 border-4 border-green-200">
                <div class="text-center mb-6">
                    <span class="bg-green-100 text-green-700 px-4 py-1 rounded-lg text-sm font-bold mb-3 inline-block font-game">ì¢…í•©ì „í˜• ë©´ì ‘</span>
                    <h3 class="text-3xl font-bold text-slate-800 font-game">ğŸ’¬ ì „ê³µ ì‹¬í™” ë©´ì ‘</h3>
                    <div class="flex justify-center gap-2 mt-2" id="interview-steps"></div>
                </div>
                <div id="interview-content" class="bg-green-50 p-8 rounded-2xl border-2 border-green-100 font-game text-lg"></div>
            </div>
        </section>

        <!-- Scene 4-2: Essay Game -->
        <section id="scene-essay" class="hidden-section max-w-2xl mx-auto slide-in mt-10 w-full">
            <div class="bg-white rounded-[2rem] shadow-xl p-8 border-4 border-purple-200">
                <div class="text-center mb-8">
                    <span class="bg-purple-100 text-purple-700 px-4 py-1 rounded-lg text-sm font-bold mb-3 inline-block font-game">ë…¼ìˆ ì „í˜•</span>
                    <h3 class="text-3xl font-bold text-slate-800 font-game">âœï¸ ë…¼ìˆ  ê³ ì‚¬</h3>
                </div>
                <div id="essay-content" class="bg-purple-50 p-8 rounded-2xl border-2 border-purple-100 font-game text-lg"></div>
            </div>
        </section>

        <!-- Scene 4-3: Arts Practical -->
        <section id="scene-practical" class="hidden-section max-w-2xl mx-auto slide-in mt-10 w-full text-center">
            <div class="bg-white rounded-[2rem] shadow-xl p-8 border-4 border-orange-200">
                <div class="text-center mb-6">
                    <span class="bg-orange-100 text-orange-700 px-4 py-1 rounded-lg text-sm font-bold mb-3 inline-block font-game">ì˜ˆì²´ëŠ¥ ì‹¤ê¸°</span>
                    <h3 class="text-3xl font-bold text-slate-800 font-game">âš¡ ìˆœë°œë ¥ & ë¦¬ë“¬ í…ŒìŠ¤íŠ¸</h3>
                    <p class="text-slate-500 mt-2 font-cute text-xl">1ë‹¨ê³„: ì´ˆë¡ìƒ‰ í´ë¦­ / 2ë‹¨ê³„: ë¦¬ë“¬ ë§ì¶”ê¸°</p>
                </div>
                
                <div id="reaction-stage" class="block">
                     <div id="reaction-area" class="reaction-box reaction-waiting h-64 rounded-3xl flex items-center justify-center text-white text-4xl font-black font-game shadow-inner transform active:scale-95 transition" onclick="handleReactionClick()">ì¤€ë¹„...</div>
                </div>
                
                <div id="rhythm-stage" class="hidden">
                    <div class="w-full bg-slate-200 h-8 rounded-full relative mb-8 overflow-hidden border-2 border-slate-300">
                        <div class="absolute left-1/2 top-0 w-8 h-full bg-yellow-400 -ml-4 opacity-50 z-0"></div> <!-- Target -->
                        <div id="rhythm-bar" class="absolute left-0 top-0 w-4 h-full bg-red-500 z-10"></div> <!-- Moving Bar -->
                    </div>
                    <button onclick="handleRhythmClick()" class="bg-orange-500 text-white px-10 py-4 rounded-2xl font-black font-game text-2xl shadow-lg active:scale-95 hover:bg-orange-600 transition">HIT! ğŸ¥</button>
                </div>

                <div id="practical-result" class="mt-4 text-3xl font-bold text-slate-800 font-game h-10"></div>
                <button id="practical-next-btn" class="hidden mt-6 bg-slate-800 text-white px-8 py-3 rounded-xl hover:bg-black transition font-game text-xl">ë‹¤ìŒìœ¼ë¡œ</button>
            </div>
        </section>

        <!-- Scene 5: Susi Result -->
        <section id="scene-susi-result" class="hidden-section max-w-6xl mx-auto slide-in w-full">
            <div class="bg-white rounded-[2.5rem] shadow-xl p-10 text-center min-h-[600px] flex flex-col justify-center relative border-8 border-blue-50">
                <h2 class="text-4xl font-black mb-6 text-slate-800 font-game">ğŸ‰ ìˆ˜ì‹œ í•©ê²©ì ë°œí‘œ ğŸ‰</h2>
                <div id="susi-result-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-10"></div>
                <div id="susi-outcome-controls" class="hidden border-t-2 border-dashed border-slate-200 pt-10">
                    <div id="susi-pass-msg" class="hidden">
                        <p class="text-3xl font-bold text-green-600 mb-2 font-game animate-bounce">ì¶•í•˜í•©ë‹ˆë‹¤! í•©ê²©!</p>
                        <button id="go-to-final-choice-susi" class="bg-slate-800 hover:bg-black text-white font-black py-4 px-12 rounded-2xl shadow-xl font-game text-xl transition hover:scale-105">ìµœì¢… ë“±ë¡í•˜ê¸° âœ¨</button>
                    </div>
                    <div id="susi-fail-msg" class="hidden">
                        <p class="text-2xl font-bold text-slate-500 mb-2 font-game">ì•„ì‰½ê²Œë„ ë¶ˆí•©ê²©ì…ë‹ˆë‹¤ ğŸ˜­</p>
                        <button id="go-to-jeongsi" class="bg-blue-500 hover:bg-blue-600 text-white font-black py-4 px-12 rounded-2xl shadow-xl font-game text-xl transition hover:scale-105">ì •ì‹œ ë„ì „í•˜ê¸° ğŸ”¥</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Scene 6: Jeongsi Application -->
        <section id="scene-jeongsi" class="hidden-section slide-in w-full max-w-6xl">
            <div class="text-center mb-8">
                <span class="bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full text-sm font-black mb-2 inline-block font-game border-2 border-indigo-200">STEP 2</span>
                <h2 class="text-3xl font-black text-slate-800 font-game">ì •ì‹œ ì›ì„œ ì ‘ìˆ˜</h2>
                <p class="text-slate-500 mt-2 font-bold font-game text-sm">ê°€/ë‚˜/ë‹¤êµ° ì´ 3ì¥ ì§€ì› / <span class="text-indigo-500">AI ì¶”ì²œ ì°¸ê³ </span></p>
            </div>
            <div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[600px]">
                <div class="lg:w-2/3 flex flex-col h-[500px] lg:h-full bg-white rounded-[2rem] shadow-lg p-6 overflow-hidden border-4 border-slate-100">
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2 flex-shrink-0 scrollbar-hide font-game">
                        <button class="j-filter-btn active bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap transition shadow-md" data-filter="all">ì „ì²´ë³´ê¸°</button>
                        <button class="j-filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="sky">SKY</button>
                        <button class="j-filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="in_seoul_top">ì¸ì„œìš¸ ìƒìœ„</button>
                        <button class="j-filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="in_seoul_mid">ì¸ì„œìš¸/ìˆ˜ë„ê¶Œ</button>
                        <button class="j-filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="jigeoguk">ì§€ê±°êµ­</button>
                        <button class="j-filter-btn bg-white border-2 border-slate-200 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap hover:bg-slate-50 transition" data-filter="metro_low">ê²½ê¸°/ì¶©ì²­ê¶Œ</button>
                    </div>
                    <div id="jeongsi-uni-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto pr-2 pb-2 h-full"></div>
                </div>
                <div class="lg:w-1/3 flex flex-col h-auto lg:h-full bg-white rounded-[2rem] shadow-cute p-6 border-4 border-indigo-200 relative">
                     <div class="absolute -top-4 -right-4 bg-purple-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-black text-xl shadow-md z-10 bounce-slow" id="jeongsi-badge">0</div>
                     <h3 class="font-bold text-2xl text-slate-800 font-game mb-4 border-b-2 border-dashed border-indigo-100 pb-2">ğŸ“‚ ì •ì‹œ ì›ì„œí•¨</h3>
                    <div class="flex-grow overflow-y-auto bg-indigo-50 rounded-xl p-3 mb-4 inner-shadow min-h-[150px] lg:min-h-0">
                        <ul id="jeongsi-cart" class="space-y-2 text-sm font-game"></ul>
                    </div>
                    <button id="submit-jeongsi" disabled class="w-full bg-slate-200 text-slate-400 font-black py-4 rounded-xl transition-all shadow-none cursor-not-allowed text-xl font-game">ì ‘ìˆ˜í•˜ê¸°</button>
                </div>
            </div>
        </section>

        <!-- Scene 7: Jeongsi Result Announcement -->
        <section id="scene-jeongsi-announce" class="hidden-section max-w-3xl mx-auto slide-in text-center mt-10 w-full">
            <div class="bg-white p-12 rounded-[2.5rem] shadow-2xl border-4 border-indigo-100">
                <h2 class="text-4xl font-black text-slate-800 font-game mb-8">ì •ì‹œ í•©ê²©ì ë°œí‘œ</h2>
                <div id="jeongsi-loading" class="flex justify-center mb-10"><i class="fas fa-spinner fa-spin text-6xl text-indigo-300"></i></div>
                <div id="jeongsi-results-container" class="grid gap-4 opacity-0 transition-opacity duration-1000"></div>
                
                <div id="jeongsi-next-controls" class="hidden mt-10">
                    <button id="go-to-final-choice-jeongsi" class="hidden bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-xl transition transform hover:scale-105 text-lg font-game">ìµœì¢… ë“±ë¡í•˜ê¸° âœ¨</button>
                    
                    <div id="jeongsi-fail-options" class="hidden">
                        <p class="text-2xl font-bold text-slate-700 mb-6 font-game">ëª¨ë“  ëŒ€í•™ì— ë¶ˆí•©ê²©í–ˆìŠµë‹ˆë‹¤..ğŸ˜­</p>
                        <div class="flex flex-col gap-3 justify-center max-w-md mx-auto font-game">
                            <!-- RETRY BUTTONS -->
                            <button onclick="window.resetGame('jaesu')" class="bg-red-400 hover:bg-red-500 text-white px-8 py-4 rounded-2xl font-bold shadow-md transition flex items-center justify-between text-lg">
                                <span>ğŸ”¥ ì¬ìˆ˜í•˜ê¸°</span> <span class="text-sm bg-black/20 px-2 py-1 rounded">ë‚´ì‹  -0.5</span>
                            </button>
                            <button onclick="window.resetGame('gunsu')" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-2xl font-bold shadow-md transition flex items-center justify-between text-lg">
                                <span>ğŸª– êµ°ìˆ˜í•˜ê¸°</span> <span class="text-sm bg-black/20 px-2 py-1 rounded">ë‚´ì‹  -0.7 / í€´ì¦ˆ 10ê°œ</span>
                            </button>
                            <button onclick="window.showEncouragementLetter()" class="bg-slate-500 hover:bg-slate-600 text-white px-8 py-4 rounded-2xl font-bold shadow-md transition flex items-center justify-center text-lg">
                                ğŸ’Œ ê²°ê³¼ ìŠ¹ë³µí•˜ê¸° (í¸ì§€ ë³´ê¸°)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Scene 9: Final Selection -->
        <section id="scene-final-select" class="hidden-section max-w-3xl mx-auto slide-in text-center mt-10 w-full">
            <div class="bg-white p-10 rounded-[3rem] shadow-cute border-4 border-blue-200">
                <h2 class="text-4xl font-black text-slate-800 font-game mb-4">ìµœì¢… ëŒ€í•™ ì„ íƒ</h2>
                <div id="final-candidate-list" class="grid gap-4 mb-8 font-game"></div>
            </div>
        </section>

        <!-- Scene 8: Final Certificate -->
        <section id="scene-final" class="hidden-section max-w-3xl mx-auto slide-in text-center mt-10 w-full">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border-8 border-yellow-200 relative overflow-hidden">
                <i class="fas fa-crown text-8xl text-yellow-400 mb-6 drop-shadow-md mt-6 block bounce-slow"></i>
                <h2 class="text-5xl font-black text-slate-800 mb-2 font-game">ìµœì¢… í•©ê²©ì¦</h2>
                <div id="final-university-display" class="my-10 p-8 bg-slate-50 rounded-3xl border-2 border-slate-100 font-game"></div>
                
                <div class="bg-indigo-50 p-6 rounded-2xl text-left border border-indigo-100 shadow-inner font-game">
                    <h3 class="font-bold text-indigo-800 mb-4 border-b border-indigo-200 pb-2 text-sm"><i class="fas fa-file-invoice mr-2"></i>ìµœì¢… ë¦¬í¬íŠ¸</h3>
                    <div class="grid grid-cols-2 gap-6 text-lg">
                        <div><span class="text-indigo-400 block text-xs mb-1">ì´ë¦„</span> <span class="font-bold final-name text-slate-800"></span></div>
                        <div><span class="text-indigo-400 block text-xs mb-1">ê³ êµ</span> <span class="font-bold text-slate-800 final-school-display"></span></div>
                        <div><span class="text-indigo-400 block text-xs mb-1">ë‚´ì‹ </span> <span class="font-bold text-blue-600 final-gpa-display"></span></div>
                        <div><span class="text-indigo-400 block text-xs mb-1">ìˆ˜ëŠ¥</span> <span class="font-bold text-purple-600 final-sat-display"></span>%</div>
                    </div>
                </div>
                <div class="mt-8">
                     <button onclick="window.showEncouragementLetter()" class="bg-pink-400 hover:bg-pink-500 text-white px-8 py-3 rounded-xl font-game shadow-md text-lg mb-4 w-full">ğŸ’Œ ì„ ìƒë‹˜ì˜ í¸ì§€ ì½ê¸°</button>
                </div>
                <button onclick="location.reload()" class="bg-slate-800 text-white px-12 py-5 rounded-2xl hover:bg-black shadow-xl font-bold transition transform hover:scale-105 mb-4 group font-game text-xl">ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </section>

        <!-- Scene 10: Letter Ending -->
        <section id="scene-letter" class="hidden-section max-w-2xl mx-auto slide-in mt-10 w-full text-center">
            <div class="letter-paper p-10 rounded-[2.5rem] relative overflow-hidden text-left font-cute text-2xl text-slate-700 leading-relaxed shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-4 bg-yellow-200 opacity-50"></div>
                <p class="mb-6 font-bold text-3xl text-indigo-600">ì‚¬ë‘í•˜ëŠ” ìˆ˜í—˜ìƒ ì—¬ëŸ¬ë¶„ê»˜,</p>
                <p class="mb-4">ê¸´ ì‹œê°„ ë¬µë¬µíˆ ë‹¬ë ¤ì˜¤ëŠë¼ ì •ë§ ê³ ìƒ ë§ì•˜ìŠµë‹ˆë‹¤. ì…ì‹œë¼ëŠ” í° ì‚°ì„ ë„˜ì€ ë„¤ê°€ ì„ ìƒë‹˜ì€ ì°¸ ëŒ€ê²¬í•˜ê³  ìë‘ìŠ¤ëŸ½ë‹¨ë‹¤.</p>
                <p class="mb-4">ê²°ê³¼ê°€ ì–´ë– í•˜ë“  ë„ˆë¼ëŠ” ì¡´ì¬ì˜ ê°€ì¹˜ëŠ” ë³€í•˜ì§€ ì•Šìœ¼ë‹ˆ, ì´ì œëŠ” ë¬´ê±°ìš´ ì§ì„ ë‚´ë ¤ë†“ê³  ë§ˆìŒê» ìˆ¨ ì‰¬ë©° ë„ˆë§Œì˜ ì†ë„ë¡œ ë‹¤ìŒ ê³„ì ˆì„ ë§ì´í•˜ê¸¸ ë°”ë¼.</p>
                <p class="mb-8">ë„¤ê°€ ê±¸ì–´ê°ˆ ëª¨ë“  ê¸¸ ìœ„ì— ë”°ëœ»í•œ í–‡ì‚´ê³¼ ì‘ì›ì´ ê°€ë“í•˜ê¸°ë¥¼ ë°”ë„ê²Œ.</p>
                <p class="text-right font-bold text-pink-500 text-xl">- ìœ ì›ì„ T ë“œë¦¼ -</p>
                
                <div class="mt-12 text-center">
                    <button onclick="location.reload()" class="bg-indigo-500 text-white px-10 py-4 rounded-2xl font-game hover:bg-indigo-600 shadow-lg text-lg transition hover:scale-105">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ğŸƒ</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-100 text-slate-400 text-center p-6 text-xs font-bold font-game">
        <p>Copyright â“’ 2026 <span class="text-pink-400">Yoo Won Seok</span>. All rights reserved.</p>
    </footer>
    
    <!-- Susi Type Modal -->
    <div id="type-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-sm w-full p-8 transform scale-100 transition-transform">
            <div class="text-center mb-6">
                <h3 class="text-3xl font-black text-slate-800 font-game">ì „í˜• ì„ íƒ</h3>
                <p class="text-lg text-slate-500 mt-1 font-cute font-bold" id="modal-uni-name">ëŒ€í•™êµ</p>
                <p class="text-sm text-red-500 mt-2 font-bold bg-red-50 inline-block px-2 py-1 rounded" id="modal-uni-chojeo"></p>
            </div>
            
            <div class="space-y-3 font-game">
                <button class="type-select-btn w-full p-4 border-2 border-slate-100 rounded-2xl hover:border-blue-500 hover:bg-blue-50 transition text-left group bg-white" data-type="êµê³¼">
                    <div>
                        <div class="font-bold text-slate-700 text-lg group-hover:text-blue-600">í•™ìƒë¶€ êµê³¼</div>
                        <div class="text-xs text-slate-400 mt-0.5">ë‚´ì‹  100% + ìµœì €</div>
                    </div>
                    <i class="fas fa-calculator text-slate-300 group-hover:text-blue-500 text-2xl"></i>
                </button>
                <button class="type-select-btn w-full p-4 border-2 border-slate-100 rounded-2xl hover:border-green-500 hover:bg-green-50 transition text-left group bg-white" data-type="ì¢…í•©">
                    <div>
                        <div class="font-bold text-slate-700 text-lg group-hover:text-green-600">í•™ìƒë¶€ ì¢…í•©</div>
                        <div class="text-xs text-slate-400 mt-0.5">ì„œë¥˜ + ë©´ì ‘</div>
                    </div>
                    <i class="fas fa-user-tie text-slate-300 group-hover:text-green-500 text-2xl"></i>
                </button>
                <button class="type-select-btn w-full p-4 border-2 border-slate-100 rounded-2xl hover:border-purple-500 hover:bg-purple-50 transition text-left group bg-white" data-type="ë…¼ìˆ ">
                    <div>
                        <div class="font-bold text-slate-700 text-lg group-hover:text-purple-600">ë…¼ìˆ  ì „í˜•</div>
                        <div class="text-xs text-slate-400 mt-0.5">ë‚´ì‹ â†“ + ë…¼ìˆ </div>
                    </div>
                    <i class="fas fa-pen-nib text-slate-300 group-hover:text-purple-500 text-2xl"></i>
                </button>
            </div>
            <button onclick="closeModal()" class="mt-6 w-full py-3 text-slate-400 hover:text-slate-600 font-bold transition font-game text-lg">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // --- Global State ---
        let activeRetryMode = null; 

        // --- Sound Effects (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSuccessSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function playFailSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime); 
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        // --- University Data (Expanded) ---
        const universities = [
            { id: 1, name: "ì„œìš¸ëŒ€í•™êµ", tier: "sky", cut_h: 1.15, cut_n: 1.20, jeongsi_cut: 99.0, chojeo: 96, gender:'all', logo: "fas fa-university", color: "text-blue-900" },
            { id: 2, name: "ì—°ì„¸ëŒ€í•™êµ", tier: "sky", cut_h: 1.45, cut_n: 1.50, jeongsi_cut: 97.5, chojeo: 95, gender:'all', logo: "fas fa-eagle", color: "text-blue-700" },
            { id: 3, name: "ê³ ë ¤ëŒ€í•™êµ", tier: "sky", cut_h: 1.55, cut_n: 1.60, jeongsi_cut: 97.0, chojeo: 95, gender:'all', logo: "fas fa-shield-cat", color: "text-red-800" },
            { id: 4, name: "ì„œê°•ëŒ€í•™êµ", tier: "in_seoul_top", cut_h: 1.65, cut_n: 1.70, jeongsi_cut: 94.5, chojeo: 92, gender:'all', logo: "fas fa-star", color: "text-red-600" },
            { id: 5, name: "ì„±ê· ê´€ëŒ€í•™êµ", tier: "in_seoul_top", cut_h: 1.70, cut_n: 1.75, jeongsi_cut: 95.0, chojeo: 92, gender:'all', logo: "fas fa-leaf", color: "text-green-700" },
            { id: 6, name: "í•œì–‘ëŒ€í•™êµ", tier: "in_seoul_top", cut_h: 1.75, cut_n: 1.80, jeongsi_cut: 94.0, chojeo: 92, gender:'all', logo: "fas fa-lion", color: "text-blue-600" },
            { id: 12, name: "ê±´êµ­ëŒ€í•™êµ", tier: "in_seoul_mid", cut_h: 2.20, cut_n: 2.25, jeongsi_cut: 90.0, chojeo: 87, gender:'all', logo: "fas fa-horse-head", color: "text-green-600" },
            { id: 13, name: "ë™êµ­ëŒ€í•™êµ", tier: "in_seoul_mid", cut_h: 2.30, cut_n: 2.35, jeongsi_cut: 89.0, chojeo: 86, gender:'all', logo: "fas fa-dharmachakra", color: "text-orange-600" },
            { id: 30, name: "ë¶€ì‚°ëŒ€í•™êµ", tier: "jigeoguk", cut_h: 3.0, cut_n: 3.1, jeongsi_cut: 83.0, chojeo: 82, gender:'all', logo: "fas fa-mountain", color: "text-blue-700" },
            { id: 50, name: "í•œê²½êµ­ë¦½ëŒ€", tier: "metro_low", cut_h: 3.8, cut_n: 4.2, jeongsi_cut: 72.0, chojeo: 0, gender:'all', logo: "fas fa-leaf", color: "text-green-600" },
            { id: 51, name: "ìˆ˜ì›ëŒ€í•™êµ", tier: "metro_low", cut_h: 4.0, cut_n: 4.3, jeongsi_cut: 70.0, chojeo: 0, gender:'all', logo: "fas fa-bell", color: "text-yellow-600" },
            { id: 57, name: "ëŒ€ì§„ëŒ€í•™êµ", tier: "metro_low", cut_h: 4.8, cut_n: 5.2, jeongsi_cut: 60.0, chojeo: 0, gender:'all', logo: "fas fa-mountain", color: "text-blue-400" },
            { id: 58, name: "í˜‘ì„±ëŒ€í•™êµ", tier: "metro_low", cut_h: 4.9, cut_n: 5.3, jeongsi_cut: 58.0, chojeo: 0, gender:'all', logo: "fas fa-hand-holding-heart", color: "text-pink-500" },
            { id: 59, name: "ë°±ì„ëŒ€í•™êµ", tier: "metro_low", cut_h: 5.0, cut_n: 5.4, jeongsi_cut: 57.0, chojeo: 0, gender:'all', logo: "fas fa-book", color: "text-blue-600" },
            { id: 60, name: "ë‚¨ì„œìš¸ëŒ€", tier: "metro_low", cut_h: 5.2, cut_n: 5.5, jeongsi_cut: 55.0, chojeo: 0, gender:'all', logo: "fas fa-star", color: "text-yellow-500" }
            // ... (Includes all previous universities)
        ];

        // --- Expanded Quiz Data (50+) ---
        const quizPool = [
            { subject: "êµ­ì–´", q: "[ê³ 3] 'ìê¸° ê²°ì •ì„± ì´ë¡ 'ì—ì„œ ë³´ìƒì´ë‚˜ ì²˜ë²Œì— ì˜í•´ ìœ ë°œë˜ëŠ” ë™ê¸° ìœ í˜•ì€?", options: ["ë‚´ì¬ì  ë™ê¸°", "ìê¸° ì™¸ì  ì¡°ì ˆ", "í™•ì¸ëœ ì¡°ì ˆ", "í†µí•©ëœ ì¡°ì ˆ"], a: 1 },
            { subject: "ìˆ˜í•™", q: "[ê³ 3] 8^(1/3) Ã— 16^(1/2) ì˜ ê°’ì€?", options: ["2", "4", "8", "16"], a: 2 },
            { subject: "ì˜ì–´", q: "[ê³ 3] 'flourishing'ì˜ ë¬¸ë§¥ìƒ ì˜ë¯¸ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?", options: ["declining", "prospering", "shrinking", "hidden"], a: 1 },
            { subject: "ì‚¬íšŒ", q: "[ê³ 3] ë¦¬ì¹´ë„ì˜ ë¹„êµ ìš°ìœ„ë¡  í•µì‹¬ ì›ë¦¬ëŠ”?", options: ["ì ˆëŒ€ ìš°ìœ„ íŠ¹í™”", "ê¸°íšŒë¹„ìš© ìµœì†Œí™” íŠ¹í™”", "ëª¨ë“  ì¬í™” ìê¸‰ìì¡±", "ìˆ˜ì… ê¸ˆì§€"], a: 1 },
            { subject: "ê³¼í•™", q: "[ê³ 3] ì—˜ë‹ˆë‡¨ ì‹œê¸° ë™íƒœí‰ì–‘ ì ë„ ë¶€ê·¼ í•´ì—­ì˜ íŠ¹ì§•ì€?", options: ["ë¬´ì—­í’ ê°•í™”", "ìš©ìŠ¹ ê°•í™”", "í‘œì¸µ ìˆ˜ì˜¨ ìƒìŠ¹", "ê¸°ì•• ìƒìŠ¹"], a: 2 },
            { subject: "í•œêµ­ì‚¬", q: "[ê³ 3] ë¶€ì—¬ì˜ 12ì›” ì œì²œ í–‰ì‚¬ ì´ë¦„ì€?", options: ["ë™ë§¹", "ë¬´ì²œ", "ì˜ê³ ", "ê³„ë¦¼"], a: 2 },
            { subject: "ìˆ˜í•™", q: "[ê³ 3] í•¨ìˆ˜ f(x)=x^3-3x^2+4 ì˜ ê·¹ì†Ÿê°’ì€?", options: ["0", "4", "-4", "2"], a: 0 },
            { subject: "ì˜ì–´", q: "[ê³ 3] ë¹ˆì¹¸ ì¶”ë¡ : Technology has changed the way we _____.", options: ["sleep", "interact", "eat", "breath"], a: 1 }
        ];

        // --- Major Specific Questions ---
        function getMajorSpecificQuestion(major) {
            if (!major) return { q: "ì „ê³µê³¼ ê´€ë ¨í•˜ì—¬ ë³¸ì¸ì´ ë…¸ë ¥í•œ ì ì„ ë§í•´ë³´ì„¸ìš”.", options: ["ì±…ì„ ë§ì´ ì½ì—ˆìŠµë‹ˆë‹¤.", "ë™ì•„ë¦¬ í™œë™ì„ í–ˆìŠµë‹ˆë‹¤.", "ì„±ì  ê´€ë¦¬ë¥¼ í–ˆìŠµë‹ˆë‹¤.", "ë”±íˆ ì—†ìŠµë‹ˆë‹¤."], a: 1 };
            const m = major.toLowerCase();
            if (m.includes("ì»´í“¨í„°") || m.includes("ì†Œí”„íŠ¸ì›¨ì–´") || m.includes("ai")) {
                return { q: "AI ìœ¤ë¦¬ ë¬¸ì œì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?", options: ["ê°œë°œì„ ë©ˆì¶°ì•¼ í•©ë‹ˆë‹¤.", "ê·œì œì™€ ë°œì „ì´ ë³‘í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.", "ë¬´ì¡°ê±´ ë°œì „ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.", "ì˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤."], a: 1 };
            } else if (m.includes("ê²½ì˜") || m.includes("ê²½ì œ")) {
                return { q: "ìµœê·¼ ESG ê²½ì˜ì´ í™”ë‘ì¸ë°, ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†ŒëŠ”?", options: ["í™˜ê²½(E)", "ì‚¬íšŒ(S)", "ì§€ë°°êµ¬ì¡°(G)", "ì´ìœ¤ ì°½ì¶œ"], a: 0 };
            } else if (m.includes("ê°„í˜¸") || m.includes("ì˜í•™") || m.includes("ë³´ê±´")) {
                return { q: "í™˜ìì˜ ìê¸°ê²°ì •ê¶Œê³¼ ì˜ì‚¬ì˜ íŒë‹¨ì´ ì¶©ëŒí•  ë•Œ?", options: ["ì˜ì‚¬ì˜ íŒë‹¨ì„ ë”°ë¥¸ë‹¤.", "í™˜ìë¥¼ ì„¤ë“í•˜ë˜ ê²°ì •ì„ ì¡´ì¤‘í•œë‹¤.", "ê°€ì¡±ì—ê²Œ ë¬»ëŠ”ë‹¤.", "ë²•ëŒ€ë¡œ í•œë‹¤."], a: 1 };
            } else if (m.includes("ë””ìì¸") || m.includes("ì˜ˆìˆ ") || m.includes("ë¯¸ìˆ ")) {
                return { q: "ì¢‹ì€ ë””ìì¸ì´ë€ ë¬´ì—‡ì´ë¼ê³  ìƒê°í•©ë‹ˆê¹Œ?", options: ["ì˜ˆìœ ê²ƒ", "ê¸°ëŠ¥ì ì¸ ê²ƒ", "ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒ", "ë¹„ì‹¼ ê²ƒ"], a: 2 };
            } else if (m.includes("ì²´ìœ¡") || m.includes("ìŠ¤í¬ì¸ ")) {
                return { q: "ìŠ¤í¬ì¸ ë§¨ì‹­ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê°€ì¹˜ëŠ”?", options: ["ìŠ¹ë¦¬", "ê³µì •ì„±", "ì¸ê¸°", "ì—°ë´‰"], a: 1 };
            } else {
                return { q: `[${major}] ì „ê³µì„ ì„ íƒí•œ êµ¬ì²´ì ì¸ ì´ìœ ëŠ”?`, options: ["ì„±ì  ë§ì¶°ì„œ", "ì·¨ì—… ì˜ ë  ê²ƒ ê°™ì•„ì„œ", "ê´€ë ¨ ì„œì ì„ ì½ê³  í¥ë¯¸ë¥¼ ëŠê»´ì„œ", "ë¶€ëª¨ë‹˜ ê¶Œìœ "], a: 2 };
            }
        }

        const nonsulQuestions = [
            { type: "ìˆ˜ë¦¬", q: "[ì‹¬í™”] ë¯¸ë¶„ê°€ëŠ¥í•œ í•¨ìˆ˜ f(x)ê°€ f'(x)=f(x)ë¥¼ ë§Œì¡±í•  ë•Œ f(x)ì˜ ê¼´ì€?", options: ["Ce^x", "Cx^2", "Clnx", "sin(x)"], a: 0 },
            { type: "ì¸ë¬¸", q: "[ì‹¬í™”] 'ì£„ìˆ˜ì˜ ë”œë ˆë§ˆ'ì—ì„œ ë‘ ì£„ìˆ˜ê°€ ëª¨ë‘ ìë°±í•˜ëŠ” í˜„ìƒì€?", options: ["íŒŒë ˆí†  ìµœì ", "ë‚´ì‰¬ ê· í˜•", "ê³µë¦¬ì£¼ì˜", "ê¸°íšŒë¹„ìš©"], a: 1 },
            { type: "ì‚¬íšŒ", q: "[ì‹¬í™”] ë¡¤ìŠ¤ì˜ ì •ì˜ë¡ ì—ì„œ 'ë¬´ì§€ì˜ ë² ì¼'ì´ ë³´ì¥í•˜ëŠ” ê²ƒì€?", options: ["ì ˆì°¨ì  ê³µì •ì„±", "ê²°ê³¼ì˜ í‰ë“±", "ìµœëŒ€ ë‹¤ìˆ˜ì˜ í–‰ë³µ", "ììœ ì§€ìƒì£¼ì˜"], a: 0 }
        ];

        // Game State
        let player = { name: "", school: "", gender: "M", track: "ì¸ë¬¸", major: "", gpa: 0, sat: 0 };
        let currentQuizQueue = [];
        let currentRound = 0;
        let maxRounds = 5;
        let consecutiveCorrect = 0;
        let susiCart = [];
        let jeongsiCart = [];
        let finalResults = []; 
        let passedUniversities = []; 
        let selectedUniForModal = null;
        let jonghapScore = 0;
        let nonsulScore = 0;
        let practicalScore = 0; 
        let reactionTimer, reactionStartTime, reactionState = 'waiting';
        let rhythmTimer, rhythmInterval;
        let interviewStage = 0;
        let currentPenaltyMode = null; // 'jaesu', 'gunsu' or null

        // --- Functions ---
        function updateStatus() {
            const els = {
                name: document.getElementById('display-name'),
                major: document.getElementById('display-major'),
                gpa: document.getElementById('display-gpa'),
                sat: document.getElementById('display-sat'),
                combo: document.getElementById('combo-badge'),
                susi: document.getElementById('susi-badge'),
                jeongsi: document.getElementById('jeongsi-badge')
            };
            if(els.name) els.name.innerText = player.name;
            if(els.major) els.major.innerText = player.major || "ë¯¸ì •";
            if(els.gpa) els.gpa.innerText = player.gpa.toFixed(2);
            if(els.sat) els.sat.innerText = player.sat;
            if(els.susi) els.susi.innerText = susiCart.length;
            if(els.jeongsi) els.jeongsi.innerText = jeongsiCart.length;
            if(els.combo) {
                 if(consecutiveCorrect > 1) {
                    els.combo.classList.remove('hidden');
                    els.combo.innerText = `ğŸ”¥ ${consecutiveCorrect} COMBO!`;
                } else {
                    els.combo.classList.add('hidden');
                }
            }
        }

        function switchScene(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
            const target = document.getElementById(id);
            if(target) {
                target.classList.remove('hidden-section');
                target.classList.add('slide-in');
                window.scrollTo(0,0);
            }
        }

        // --- Soft Reset for Retry (No Page Reload) ---
        window.resetGame = function(mode) {
            // Reset State
            player = { name: "", school: "", gender: "M", track: "ì¸ë¬¸", major: "", gpa: 0, sat: 0 };
            currentQuizQueue = [];
            currentRound = 0;
            consecutiveCorrect = 0;
            susiCart = [];
            jeongsiCart = [];
            finalResults = []; 
            passedUniversities = [];
            jonghapScore = 0; nonsulScore = 0; practicalScore = 0;
            
            // Set Mode
            currentPenaltyMode = mode;
            maxRounds = (mode === 'gunsu') ? 10 : 5;

            // UI Reset
            const alertBox = document.getElementById('penalty-alert');
            const body = document.getElementById('main-body');
            const header = document.getElementById('main-header');
            const title = document.getElementById('game-title');
            
            if(mode === 'jaesu') {
                if(alertBox) {
                    alertBox.classList.remove('hidden');
                    alertBox.innerHTML = 'âš ï¸ <b>ì¬ìˆ˜ìƒ ëª¨ë“œ ON:</b> ë‚´ì‹  -0.5 í˜ë„í‹°ê°€ ì ìš©ë©ë‹ˆë‹¤.';
                    alertBox.className = "mb-6 p-4 rounded-2xl text-sm font-bold border-2 animate-pulse text-left font-game shadow-md bg-red-50 text-red-600 border-red-200";
                }
                if(body) { body.classList.remove('bg-army'); body.classList.add('bg-cute-pattern'); }
                if(title) title.innerText = "2028 ëŒ€í•™ ì…ì‹œì˜ ì‹  (ì¬ìˆ˜)";
            } else if(mode === 'gunsu') {
                if(alertBox) {
                    alertBox.classList.remove('hidden');
                    alertBox.innerHTML = 'ğŸª– <b>êµ°ëŒ€ìŠ¤ë¦¬ê°€ ëª¨ë“œ ON:</b> ë‚´ì‹  -0.7 / í€´ì¦ˆ 10íšŒ ê¸°íšŒ!';
                    alertBox.className = "mb-6 p-4 rounded-2xl text-sm font-bold border-2 animate-pulse text-left font-game shadow-md bg-green-800 text-white border-green-900";
                }
                if(body) { body.classList.remove('bg-cute-pattern'); body.classList.add('bg-army'); }
                if(header) { header.classList.remove('bg-white/90','text-pink-600'); header.classList.add('bg-slate-900/90','text-green-400'); }
                if(title) title.innerText = "êµ°ëŒ€ìŠ¤ë¦¬ê°€ : ì „ì—­ í›„ ëŒ€í•™";
            } else {
                 // Full reset to normal
                 if(alertBox) alertBox.classList.add('hidden');
                 if(body) { body.classList.remove('bg-army'); body.classList.add('bg-cute-pattern'); }
                 if(header) { header.classList.remove('bg-slate-900/90','text-green-400'); header.classList.add('bg-white/90','text-pink-600'); }
                 if(title) title.innerText = "2027 ëŒ€í•™ ì…ì‹œì˜ ì‹ ";
                 currentPenaltyMode = null;
                 maxRounds = 5;
            }

            // Go to Intro
            switchScene('scene-intro');
            // Clear inputs
            document.querySelectorAll('#profile-form input').forEach(i => i.value = '');
        }

        // Start Form
        const profileForm = document.getElementById('profile-form');
        if(profileForm) {
            profileForm.addEventListener('submit', (e) => {
                e.preventDefault();
                player.name = document.getElementById('input-name').value;
                player.school = document.getElementById('input-school').value;
                player.major = document.getElementById('input-major').value;
                player.gender = document.getElementById('input-gender').value;
                player.track = document.getElementById('input-track').value;
                
                let rawGpa = parseFloat(document.getElementById('input-gpa').value);
                let rawSat = parseInt(document.getElementById('input-sat').value);

                // Apply Penalties immediately
                if(currentPenaltyMode === 'jaesu') rawGpa = Math.min(9.0, rawGpa + 0.5);
                if(currentPenaltyMode === 'gunsu') rawGpa = Math.min(9.0, rawGpa + 0.7);

                player.gpa = rawGpa;
                player.sat = rawSat;

                document.getElementById('status-bar').classList.remove('hidden');
                document.getElementById('status-bar').classList.add('flex');
                updateStatus();
                
                // Quiz Setup
                currentQuizQueue = [];
                for(let i=0; i<maxRounds; i++) currentQuizQueue.push(quizPool[Math.floor(Math.random()*quizPool.length)]);
                
                const tr = document.getElementById('total-rounds');
                if(tr) tr.innerText = maxRounds;

                switchScene('scene-quiz');
                loadQuiz();
            });
        }

        // 2. Quiz Logic (Safe Version)
        function loadQuiz() {
            if(currentRound >= maxRounds) { setTimeout(startSusi, 500); return; }
            
            const crEl = document.getElementById('current-round');
            if(crEl) crEl.innerText = currentRound+1;
            const trEl = document.getElementById('total-rounds');
            if(trEl) trEl.innerText = maxRounds;
            
            const fb = document.getElementById('quiz-feedback');
            if(fb) fb.classList.add('hidden');
            
            const container = document.getElementById('quiz-container');
            const title = document.getElementById('quiz-title');
            
            // Killer Logic Check
            const q = currentQuizQueue[currentRound];
            const gpaDecimal = player.gpa - Math.floor(player.gpa);
            const satMod = player.sat % 10;
            
            if ((gpaDecimal <= 0.2 || satMod >= 8) && q.subject.includes("í‚¬ëŸ¬")) {
                 if(container) container.classList.add('killer-mode');
                 if(title) { title.innerHTML = "ğŸ”¥ ìŠ¹ê¸‰ ì‹¬ì‚¬ (í‚¬ëŸ¬)!"; title.classList.add('text-red-500'); }
            } else {
                 if(container) container.classList.remove('killer-mode');
                 if(title) { title.innerHTML = "ë‘ë‡Œ í’€ê°€ë™!"; title.classList.remove('text-red-500'); }
            }

            const subEl = document.getElementById('quiz-subject');
            if(subEl) subEl.innerText = q.subject;
            const qEl = document.getElementById('quiz-question');
            if(qEl) qEl.innerText = q.q;
            
            const opts = document.getElementById('quiz-options');
            if(opts) {
                opts.innerHTML = '';
                q.options.forEach((o, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 font-bold text-slate-600 transition active:scale-95";
                    btn.innerHTML = `<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded mr-2 text-xs">${i+1}</span> ${o}`;
                    btn.onclick = () => checkAnswer(i, q.a);
                    opts.appendChild(btn);
                });
            }
        }
        
        function checkAnswer(sel, ans) {
            const fb = document.getElementById('quiz-feedback');
            const icon = document.getElementById('feedback-icon');
            const text = document.getElementById('feedback-text');
            const detail = document.getElementById('feedback-detail');
            
            if(fb) fb.classList.remove('hidden');
            const opts = document.getElementById('quiz-options');
            if(opts) opts.querySelectorAll('button').forEach(b=>b.disabled=true);
            
            if(sel===ans) {
                consecutiveCorrect++;
                const gpaBonus = 0.15 + (consecutiveCorrect-1)*0.05;
                const satBonus = 2 + (consecutiveCorrect-1)*1; // Reduced bonus
                player.gpa = Math.max(1.0, player.gpa - gpaBonus);
                player.sat = Math.min(100, player.sat + satBonus);
                
                if(icon) icon.innerHTML = "ğŸ‰";
                if(text) text.innerHTML = "ì •ë‹µì…ë‹ˆë‹¤!";
                if(detail) detail.innerHTML = `<span class="score-change score-up">ë‚´ì‹  -${gpaBonus.toFixed(2)} â–¼</span> <span class="score-change score-up">ìˆ˜ëŠ¥ +${satBonus} â–²</span>`;
            } else {
                consecutiveCorrect = 0;
                player.gpa = Math.min(9.0, player.gpa + 0.1);
                player.sat = Math.max(0, player.sat - 2);
                
                if(icon) icon.innerHTML = "ğŸ˜­";
                if(text) text.innerHTML = "ì˜¤ë‹µì…ë‹ˆë‹¤...";
                if(detail) detail.innerHTML = `<span class="score-change score-down">ë‚´ì‹  +0.1 â–²</span> <span class="score-change score-down">ìˆ˜ëŠ¥ -2 â–¼</span>`;
            }
            updateStatus();
        }
        const nextQuiz = document.getElementById('next-quiz-btn');
        if(nextQuiz) nextQuiz.onclick = () => { currentRound++; loadQuiz(); };

        // 3. Susi Logic
        function startSusi() {
            switchScene('scene-susi');
            updateStatus(); 
            renderSusiList('all');
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-slate-800','text-white'));
                    e.target.classList.add('bg-slate-800','text-white');
                    renderSusiList(e.target.dataset.filter);
                };
            });
        }
        
        function renderSusiList(filter) {
            const list = document.getElementById('susi-uni-list');
            if(!list) return;
            list.innerHTML = '';
            universities.forEach(u => {
                if(player.gender === 'M' && u.gender === 'F') return;
                if(filter !== 'all') {
                    if(filter === 'metro_low' && u.tier !== 'metro_low') return;
                    if(filter !== 'metro_low' && u.tier !== filter) return;
                }

                let targetCut = u.cut_h; 
                if(player.track === 'ìì—°') targetCut = u.cut_n;
                // Arts track simplified logic
                if(player.track === 'ì˜ˆì²´ëŠ¥') targetCut += 1.0;

                const diff = player.gpa - targetCut;
                let badge = diff <= -0.3 ? "ì•ˆì •" : (diff <= 0.2 ? "ì ì •" : "ìƒí–¥");
                let badgeColor = diff <= -0.3 ? "bg-green-100 text-green-700" : (diff <= 0.2 ? "bg-blue-100 text-blue-700" : "bg-red-100 text-red-700");

                let recommendTag = "";
                if(diff >= 0) recommendTag = '<span class="ai-recommend ml-2">ğŸ‘ AIì¶”ì²œ</span>';

                const d = document.createElement('div');
                d.className = "university-card bg-white border border-slate-100 p-4 rounded-2xl flex justify-between items-center cursor-pointer transition-all";
                d.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center text-xl ${u.color} shadow-sm border border-slate-100"><i class="${u.logo}"></i></div>
                        <div>
                            <div class="font-bold text-slate-800 font-game">${u.name} ${recommendTag}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] ${badgeColor} px-2 py-0.5 rounded-full font-bold">${badge}</span>
                                <span class="text-xs text-slate-400">ì»· ${targetCut}</span>
                            </div>
                        </div>
                    </div>
                    <button class="add-btn w-9 h-9 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white flex items-center justify-center transition"><i class="fas fa-plus"></i></button>
                `;
                d.querySelector('.add-btn').onclick = () => openTypeModal(u);
                list.appendChild(d);
            });
        }

        // Modal & Cart Logic (Susi)
        function openTypeModal(u) {
            if(susiCart.length >= 6) { alert("ìˆ˜ì‹œ ì›ì„œëŠ” ìµœëŒ€ 6ì¥ì…ë‹ˆë‹¤."); return; }
            selectedUniForModal = u;
            document.getElementById('modal-uni-name').innerText = u.name;
            const chojeoText = u.chojeo > 0 ? `ìˆ˜ëŠ¥ìµœì €: ë°±ë¶„ìœ„ ${u.chojeo}` : "ìˆ˜ëŠ¥ìµœì € ì—†ìŒ";
            document.getElementById('modal-uni-chojeo').innerText = chojeoText;
            document.getElementById('type-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('type-modal').classList.add('hidden'); selectedUniForModal=null; }
        
        document.querySelectorAll('.type-select-btn').forEach(b => {
            b.onclick = () => { 
                if(selectedUniForModal) { 
                    const type = b.dataset.type;
                    if(susiCart.find(x => x.id === selectedUniForModal.id && x.type === type)) {
                        alert("ì´ë¯¸ í•´ë‹¹ ëŒ€í•™ì˜ ë™ì¼ ì „í˜•ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤."); return;
                    }
                    susiCart.push({...selectedUniForModal, type: type}); 
                    updateSusiCart(); 
                    closeModal(); 
                } 
            };
        });

        function updateSusiCart() {
            const list = document.getElementById('susi-cart');
            const cnt = document.getElementById('susi-count');
            const btn = document.getElementById('btn-susi-submit');
            
            if(cnt) cnt.innerText = susiCart.length;
            if(list) {
                list.innerHTML = '';
                susiCart.forEach((u, i) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl text-sm pop-in shadow-sm";
                    li.innerHTML = `<div><span class="font-bold text-xs bg-gray-100 px-1 rounded mr-1">${u.type}</span> ${u.name}</div><button onclick="removeSusiItem(${i})"><i class="fas fa-times text-red-300"></i></button>`;
                    list.appendChild(li);
                });
            }
            updateStatus();

            if(btn) {
                if(susiCart.length > 0) {
                    btn.disabled = false;
                    btn.className = "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all font-game text-xl";
                    btn.innerText = `ìˆ˜ì‹œ ${susiCart.length}ì¥ ì ‘ìˆ˜í•˜ê¸°`;
                } else {
                    btn.disabled = true;
                    btn.className = "w-full bg-slate-200 text-slate-400 font-bold py-4 rounded-2xl transition-all cursor-not-allowed font-game text-xl";
                    btn.innerText = "ëŒ€í•™ì„ ì„ íƒí•˜ì„¸ìš”";
                }
            }
        }
        window.removeSusiItem = function(index) { susiCart.splice(index, 1); updateSusiCart(); }

        const susiSubmit = document.getElementById('btn-susi-submit');
        if(susiSubmit) {
            susiSubmit.onclick = () => {
                const needsExam = susiCart.some(u => u.type === 'ì¢…í•©' || u.type === 'ë…¼ìˆ ') || player.track === 'ì˜ˆì²´ëŠ¥';
                if(needsExam) switchScene('scene-exam-intro');
                else processSusiResults();
            };
        }

        window.startActualExams = function() {
            if(player.track === 'ì˜ˆì²´ëŠ¥') setupPractical(); 
            else if(susiCart.some(u=>u.type==='ì¢…í•©')) setupInterviewStage(0); 
            else if(susiCart.some(u=>u.type==='ë…¼ìˆ ')) setupEssay();
            else processSusiResults();
        }

        // --- UPGRADED Interview Logic (3 Stages) ---
        function setupInterviewStage(stage) {
            interviewStage = stage;
            switchScene('scene-interview');
            const container = document.getElementById('interview-content');
            
            const steps = [1,2,3].map(n => `<div class="w-3 h-3 rounded-full ${n<=stage+1 ? 'bg-green-500':'bg-slate-300'}"></div>`).join('');
            document.querySelector('#scene-interview .flex.justify-center').innerHTML = steps;

            let q;
            let typeLabel = "";
            
            if(stage === 0) { // Basic
                typeLabel = "ê¸°ë³¸ ì¸ì„±";
                q = { q: "ìš°ë¦¬ ëŒ€í•™ì— ì§€ì›í•˜ê²Œ ëœ ê°€ì¥ í° ë™ê¸°ëŠ”?", options: ["ì ìˆ˜ ë§ì¶°ì„œ", "ë¶€ëª¨ë‹˜ ê¶Œìœ ", "ì»¤ë¦¬í˜ëŸ¼ì— ë§¤ë£Œë˜ì–´", "ì·¨ì—… ì˜ ë  ê²ƒ ê°™ì•„ì„œ"], a: 2 };
            } else if (stage === 1) { // Applied
                typeLabel = "ìƒí™© ëŒ€ì²˜";
                q = { q: "íŒ€ í”„ë¡œì íŠ¸ ì¤‘ ë¬´ì„ìŠ¹ì°¨í•˜ëŠ” ë™ë£Œê°€ ìˆë‹¤ë©´?", options: ["ì´ë¦„ì„ ëºë‹ˆë‹¤.", "êµìˆ˜ë‹˜ê»˜ ì´ë¦…ë‹ˆë‹¤.", "ëŒ€í™”ë¡œ ì°¸ì—¬ë¥¼ ìœ ë„í•˜ê³  ì—­í• ì„ ë¶„ë‹´í•©ë‹ˆë‹¤.", "ì œê°€ ë‹¤ í•©ë‹ˆë‹¤."], a: 2 };
            } else { // Major Specific (AI Generated Feel)
                typeLabel = "ì „ê³µ ì í•©ì„±";
                const majorQ = getMajorSpecificQuestion(player.major);
                q = majorQ;
            }

            if(container) {
                container.innerHTML = `
                    <div class="mb-6"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold mb-2 inline-block">${typeLabel}</span><p class="font-bold text-xl text-slate-800 leading-relaxed">"${q.q}"</p></div>
                    <div class="grid gap-3">${q.options.map((o,i)=>`<button onclick="handleInterviewAnswer(${i}, ${q.a})" class="w-full text-left p-4 bg-white border-2 border-green-100 rounded-xl hover:bg-green-50 transition font-medium">${i+1}. ${o}</button>`).join('')}</div>
                `;
            }
        }

        window.handleInterviewAnswer = function(selected, answer) {
            if(selected === answer) jonghapScore += 0.3;
            else jonghapScore -= 0.1;

            if(interviewStage < 2) {
                setupInterviewStage(interviewStage + 1);
            } else {
                // Done
                if(susiCart.some(u=>u.type==='ë…¼ìˆ ')) setupEssay();
                else processSusiResults();
            }
        }

        // Essay
        function setupEssay() {
            switchScene('scene-essay');
            const q = nonsulQuestions[Math.floor(Math.random()*nonsulQuestions.length)];
            const container = document.getElementById('essay-content');
            if(container) {
                container.innerHTML = `
                    <div class="mb-6"><span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold mb-2 inline-block">${q.type}</span><p class="font-bold text-xl text-slate-800 leading-relaxed">${q.q}</p></div>
                    <div class="grid gap-3">${q.options.map((o,i)=>`<button onclick="nonsulScore=${i===q.a?1.0:-0.5};processSusiResults()" class="w-full text-left p-4 bg-white border-2 border-purple-100 rounded-xl hover:bg-purple-50 transition font-medium">${i+1}. ${o}</button>`).join('')}</div>
                `;
            }
        }
        
        // Practical (Enhanced Visibility & Rhythm)
        function setupPractical() {
            switchScene('scene-practical');
            // Reset to stage 1
            document.getElementById('reaction-stage').classList.remove('hidden');
            document.getElementById('rhythm-stage').classList.add('hidden');
            document.getElementById('practical-result').innerText = "";
            document.getElementById('practical-next-btn').classList.add('hidden');
            
            startReactionTest();
        }
        
        function startReactionTest() {
            const box = document.getElementById('reaction-area');
            if(box) {
                box.className = 'reaction-box reaction-waiting h-64 rounded-3xl flex items-center justify-center text-white text-4xl font-black font-game shadow-inner transform active:scale-95 transition';
                box.innerText = "ë¹¨ê°„ìƒ‰ì¼ ë•Œ ëŒ€ê¸°!";
                box.style.backgroundColor = '#ef4444'; // Explicit Red
            }
            reactionState = 'waiting';
            const delay = 2000 + Math.random() * 3000;
            
            if(reactionTimer) clearTimeout(reactionTimer);
            
            reactionTimer = setTimeout(() => {
                reactionState = 'ready';
                if(box) {
                    box.className = 'reaction-box reaction-ready h-64 rounded-3xl flex items-center justify-center text-white text-4xl font-black font-game shadow-inner';
                    box.innerText = "ì§€ê¸ˆ í´ë¦­í•˜ì„¸ìš”!!!";
                    box.style.backgroundColor = '#22c55e'; // Explicit Green
                }
                reactionStartTime = Date.now();
            }, delay);
        }
        
        window.handleReactionClick = function() {
            if(reactionState === 'waiting') {
                clearTimeout(reactionTimer);
                alert("ë„ˆë¬´ ë¹¨ëìŠµë‹ˆë‹¤! ì‹¤ê²© ì²˜ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                practicalScore -= 0.5;
                startRhythmTest(); // Move to next
            } else if (reactionState === 'ready') {
                const time = Date.now() - reactionStartTime;
                document.getElementById('reaction-area').innerText = `${time}ms ì„±ê³µ!`;
                if(time < 300) practicalScore += 1.0;
                else if(time < 500) practicalScore += 0.5;
                
                setTimeout(startRhythmTest, 1000);
            }
        }
        
        function startRhythmTest() {
            document.getElementById('reaction-stage').classList.add('hidden');
            document.getElementById('rhythm-stage').classList.remove('hidden');
            
            // Simple bar animation logic handled by CSS, we just check position or random for now to keep it simple
            // For a better game feel, we'd need requestAnimationFrame, but let's simulate a timing check
        }
        
        window.handleRhythmClick = function() {
            // Simplified Rhythm Check: Random luck for now + reaction bonus
            const luck = Math.random();
            let msg = "";
            if(luck > 0.7) { msg = "Perfect!!"; practicalScore += 0.5; }
            else if(luck > 0.4) { msg = "Good!"; practicalScore += 0.3; }
            else { msg = "Bad.."; practicalScore -= 0.1; }
            
            document.getElementById('practical-result').innerText = `ë¦¬ë“¬ íŒì •: ${msg}`;
            showPracticalNext();
        }

        function showPracticalNext() {
            const btn = document.getElementById('practical-next-btn');
            if(btn) {
                btn.classList.remove('hidden');
                btn.onclick = () => {
                    if(susiCart.some(u=>u.type==='ì¢…í•©')) setupInterviewStage(0);
                    else if(susiCart.some(u=>u.type==='ë…¼ìˆ ')) setupEssay();
                    else processSusiResults();
                };
            }
        }

        // Susi Processing
        function processSusiResults() {
            switchScene('scene-susi-result');
            const list = document.getElementById('susi-result-list');
            if(list) list.innerHTML = '';
            passedUniversities = [];
            
            susiCart.forEach((u, i) => {
                setTimeout(() => {
                    let passed = false;
                    let baseCut = (player.track === 'ìì—°') ? u.cut_n : u.cut_h;
                    if(player.track === 'ì˜ˆì²´ëŠ¥') baseCut += 1.0; 

                    if (u.type === 'êµê³¼') {
                        if (player.sat < u.chojeo) passed = false; 
                        else {
                            if (player.gpa <= baseCut + 0.1) passed = true; 
                            else passed = Math.random() < 0.2; 
                        }
                    } else {
                        let finalScore = baseCut;
                        if(u.type==='ì¢…í•©') finalScore += (0.3 + jonghapScore);
                        if(u.type==='ë…¼ìˆ ') finalScore += (1.0 + nonsulScore);
                        if(player.track === 'ì˜ˆì²´ëŠ¥') finalScore += practicalScore;
                        const diff = finalScore - player.gpa;
                        let prob = (diff>0.5)?95:(diff>0)?70:(diff>-0.3)?30:5;
                        passed = Math.random()*100 < prob;
                    }

                    if(passed) {
                        passedUniversities.push({...u, method: 'ìˆ˜ì‹œ'});
                        playSuccessSound();
                    } else {
                        playFailSound();
                    }

                    const d = document.createElement('div');
                    d.className = "bg-white border rounded-2xl p-6 shadow-sm flex flex-col items-center justify-center pop-in";
                    d.innerHTML = `
                        <div class="text-xs text-slate-400 font-bold mb-1">${u.type}</div>
                        <div class="font-bold text-lg mb-2 font-game">${u.name}</div>
                        <div class="text-xl font-black ${passed?'text-green-600':'text-slate-300'} font-game">${passed?'í•©ê²©':'ë¶ˆí•©ê²©'}</div>
                        ${(u.type==='êµê³¼' && player.sat < u.chojeo) ? '<div class="text-xs text-red-400 mt-1 font-bold">ìµœì € ë¯¸ë‹¬</div>' : ''}
                    `;
                    if(list) list.appendChild(d);

                    if(i === susiCart.length-1) {
                        document.getElementById('susi-outcome-controls').classList.remove('hidden');
                        if(passedUniversities.length > 0) document.getElementById('susi-pass-msg').classList.remove('hidden');
                        else document.getElementById('susi-fail-msg').classList.remove('hidden');
                    }
                }, i*800);
            });
        }

        const susiFinalBtn = document.getElementById('go-to-final-choice-susi');
        if(susiFinalBtn) susiFinalBtn.onclick = () => showFinalSelection(passedUniversities);
        
        const jeongsiBtn = document.getElementById('go-to-jeongsi');
        if(jeongsiBtn) jeongsiBtn.onclick = startJeongsi;

        // Jeongsi Logic
        function startJeongsi() {
            switchScene('scene-jeongsi');
            renderJeongsiList('all');
            document.querySelectorAll('.j-filter-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.j-filter-btn').forEach(b => b.classList.remove('bg-indigo-600','text-white'));
                    e.target.classList.add('bg-indigo-600','text-white');
                    renderJeongsiList(e.target.dataset.filter);
                };
            });
        }

        function renderJeongsiList(filter) {
            const list = document.getElementById('jeongsi-uni-list');
            if(!list) return;
            list.innerHTML = '';
            universities.forEach(u => {
                if(player.gender === 'M' && u.gender === 'F') return;
                if(filter !== 'all') {
                    if(filter === 'metro_low' && u.tier !== 'metro_low') return;
                    if(filter !== 'metro_low' && u.tier !== filter) return;
                }

                const diff = player.sat - u.jeongsi_cut;
                let badge = diff >= 5 ? "ì•ˆì •" : (diff >= 0 ? "ì ì •" : "ìƒí–¥");
                let badgeColor = diff >= 5 ? "bg-green-100 text-green-700" : (diff >= 0 ? "bg-blue-100 text-blue-700" : "bg-red-100 text-red-700");

                let recommendTag = "";
                if(diff >= 0) recommendTag = '<span class="ai-recommend ml-2">ğŸ‘ AIì¶”ì²œ</span>';

                const d = document.createElement('div');
                d.className = "university-card bg-white border border-slate-100 p-4 rounded-2xl flex justify-between items-center cursor-pointer transition-all";
                d.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center text-xl ${u.color} shadow-sm border border-slate-100"><i class="${u.logo}"></i></div>
                        <div>
                            <div class="font-bold text-slate-800 font-game">${u.name} ${recommendTag}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] ${badgeColor} px-2 py-0.5 rounded-full font-bold">${badge}</span>
                                <span class="text-xs text-slate-400">ì»· ${u.jeongsi_cut}%</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="addToJeongsiCart(${u.id})" class="w-9 h-9 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white flex items-center justify-center transition"><i class="fas fa-plus"></i></button>
                `;
                list.appendChild(d);
            });
        }

        window.addToJeongsiCart = (id) => {
            if(jeongsiCart.length >= 3) { alert("ì •ì‹œëŠ” 3ì¥ì…ë‹ˆë‹¤."); return; }
            if(jeongsiCart.find(x=>x.id===id)) { alert("ì´ë¯¸ ì„ íƒí–ˆìŠµë‹ˆë‹¤."); return; }
            jeongsiCart.push(universities.find(u=>u.id===id));
            updateJeongsiCart();
        }

        function updateJeongsiCart() {
            const list = document.getElementById('jeongsi-cart');
            const cnt = document.getElementById('jeongsi-count');
            const btn = document.getElementById('submit-jeongsi');
            
            if(cnt) cnt.innerText = jeongsiCart.length;
            if(list) {
                list.innerHTML = '';
                jeongsiCart.forEach((u, i) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl text-sm pop-in shadow-sm";
                    li.innerHTML = `<span>${u.name}</span> <button onclick="removeJeongsiItem(${i})"><i class="fas fa-times text-red-300"></i></button>`;
                    list.appendChild(li);
                });
            }
            updateStatus();

            if(btn) {
                if(jeongsiCart.length > 0) {
                    btn.disabled = false;
                    btn.className = "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all font-game text-xl";
                } else {
                    btn.disabled = true;
                    btn.className = "w-full bg-slate-200 text-slate-400 font-bold py-4 rounded-2xl cursor-not-allowed font-game text-xl";
                }
            }
        }
        
        window.removeJeongsiItem = function(index) {
            jeongsiCart.splice(index, 1);
            updateJeongsiCart();
        }

        const jeongsiSubmit = document.getElementById('submit-jeongsi');
        if(jeongsiSubmit) {
            jeongsiSubmit.onclick = () => {
                jeongsiCart.forEach(u => {
                    const diff = player.sat - u.jeongsi_cut;
                    let prob = 50 + diff*5;
                    if(prob>95) prob=95; if(prob<5) prob=5;
                    const passed = Math.random()*100 < prob;
                    if(passed) passedUniversities.push({...u, method: 'ì •ì‹œ'});
                    finalResults.push({name:u.name, status:passed?'í•©ê²©':'ë¶ˆí•©ê²©', type: 'ì •ì‹œ'});
                });

                switchScene('scene-jeongsi-announce');
                const container = document.getElementById('jeongsi-results-container');
                if(container) container.innerHTML = '';
                
                setTimeout(() => {
                    const loader = document.getElementById('jeongsi-loading');
                    if(loader) loader.classList.add('hidden');
                    if(container) container.classList.remove('opacity-0');
                    
                    finalResults.filter(r=>r.type === 'ì •ì‹œ').forEach((r, i) => { 
                        setTimeout(() => {
                            if(r.status==='í•©ê²©') playSuccessSound(); else playFailSound();
                            const d = document.createElement('div');
                            d.className = "bg-white border border-slate-100 p-5 rounded-2xl shadow-sm flex justify-between items-center pop-in";
                            d.innerHTML = `<span class="font-bold text-lg text-slate-800 font-game">${r.name}</span><span class="font-black text-xl ${r.status==='í•©ê²©'?'text-green-600':'text-slate-300'} font-game">${r.status}</span>`;
                            if(container) container.appendChild(d);
                        }, i * 800);
                    });

                    setTimeout(() => {
                        const nextControls = document.getElementById('jeongsi-next-controls');
                        if(nextControls) nextControls.classList.remove('hidden');
                        
                        if(passedUniversities.length > 0) {
                            const finalChoiceBtn = document.getElementById('go-to-final-choice-jeongsi');
                            if(finalChoiceBtn) finalChoiceBtn.classList.remove('hidden');
                        } else {
                            const failOptions = document.getElementById('jeongsi-fail-options');
                            if(failOptions) failOptions.classList.remove('hidden');
                        }
                    }, jeongsiCart.length * 800 + 500);
                }, 1500);
            };
        }

        const jeongsiFinalBtn = document.getElementById('go-to-final-choice-jeongsi');
        if(jeongsiFinalBtn) jeongsiFinalBtn.onclick = () => showFinalSelection(passedUniversities);

        function showFinalSelection(passedList) {
            switchScene('scene-final-select');
            const container = document.getElementById('final-candidate-list');
            if(container) {
                container.innerHTML = '';
                passedList.forEach(u => {
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-white border-2 border-blue-100 hover:border-blue-500 hover:bg-blue-50 p-6 rounded-2xl transition flex justify-between items-center group shadow-sm";
                    btn.innerHTML = `
                        <div class="flex items-center gap-4">
                            <i class="${u.logo} text-3xl ${u.color}"></i>
                            <div class="text-left">
                                <div class="font-bold text-xl text-slate-800 font-game">${u.name}</div>
                                <div class="text-sm text-slate-500 font-cute font-bold text-lg">${u.method} í•©ê²©</div>
                            </div>
                        </div>
                        <span class="text-blue-500 font-bold group-hover:underline font-game text-lg">ì„ íƒí•˜ê¸° âœ¨</span>
                    `;
                    btn.onclick = () => showFinalReport(u);
                    container.appendChild(btn);
                });
            }
        }

        function showFinalReport(university) {
            switchScene('scene-final');
            document.querySelector('.final-name').innerText = player.name;
            document.querySelector('.final-school-display').innerText = player.school;
            document.querySelectorAll('.final-gpa-display').forEach(e=>e.innerText=player.gpa.toFixed(2));
            document.querySelectorAll('.final-sat-display').forEach(e=>e.innerText=player.sat);
            
            const display = document.getElementById('final-university-display');
            if(display) {
                display.innerHTML = `
                    <div class="flex flex-col items-center">
                        <i class="${university.logo} text-8xl ${university.color} mb-6"></i>
                        <h3 class="text-4xl font-black text-slate-800 mb-2 font-game">${university.name}</h3>
                        <span class="bg-indigo-100 text-indigo-700 px-6 py-2 rounded-full font-bold font-game text-xl">${university.method} í•©ê²©</span>
                        <p class="mt-8 text-slate-500 text-center font-cute text-2xl font-bold leading-relaxed">
                            ìœ„ í•™ìƒì€ 2027í•™ë…„ë„ ëŒ€í•™ì…í•™ì „í˜•ì— ìµœì¢… í•©ê²©í•˜ì—¬<br>ë³¸êµì˜ ìë‘ìŠ¤ëŸ¬ìš´ ì‹ ì…ìƒì´ ë˜ì—ˆìŒì„ ì¦ëª…í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                `;
            }
            playSuccessSound();
        }

        // Letter Modal Logic
        window.showEncouragementLetter = function() {
            switchScene('scene-letter');
        };

    </script>
</body>
</html>
